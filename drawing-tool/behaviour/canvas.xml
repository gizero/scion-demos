<?xml version="1.0" encoding="utf-8"?>
<!--
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->
<!-- 
Natural-language behavioural specification:

We have a canvas, nodes, rotation and scale handles. 

Canvas has three tools: drawing rects, drawing ellipses, and transforming them.
Selects between tools by clicking buttons on a toolbar.

Only one tool can be selected at a time. 

Nodes can be selected or not selected. When selected, they are surrounded by a dashed rect.

When transform tool is selected:
    If there are selected nodes, then either the rotate or translate handles will be visible, and will eb psoitioned on the aggregate bbox of all selected nodes; otherwise, if no nodes are selected, then neither rotate nor transform handles will be shown.

    Dragging rotation handle rotates the nodes about the center point of their aggregate bbox. On mouseup, handle positions are reset.
    Dragging scale handle scales the nodes.
    Dragging selected node results in all selected nodes being dragged.
    Dragging non-selected node results in node being selected, and all other nodes being deselected.
    Dragging (no shift) on canvas results in marquee being drawn, all nodes inside of marquee being selected, and all other nodes being deselected,
    Dragging (with shift) on canvas results in marquee being drawn, all nodes inside of marquee being selected (added to selection). 

    Mouseclick (no shift) on selected node results in rotation/scale handles being toggled.

    Dragging node (no shift) will deselect other nodes, drag the node, and select this node.
    Dragging node (with shift) has same effect as dragging on canvas.

    Additionally, when no nodes are selected, and nodes are first selected, then the scale rotation handles will be shown first
        UNLESS, the last time nodes were selected, rotation handles were shown when they were deselected; 
            AND, the way the nodes are being selected now is via a drag (not a click)

When rect or ellipse drawing tools are selected:
    Rotate and translate handles will never be visible.
    When only one node is selected, then that node's resize/roundness controls will be shown.

    Mouseclick (no shift) on selected node HAS NO EFFECT.

    Dragging (on canvas, rect, wherever) results in a new element being draw, created and selected. On mouseup, all other elements are deselect.

In both:
    Mouseclick (no shift) on canvas results in all nodes being selected.
    Mouseclick (with shift) on node results in node's selection state being toggled.

    Mouseclick (no shift) on non-selected node results in node being selected, and all other nodes being deselected.

    Ctrl+A selects all
    Delete deletes selected nodes (and deselects them in the process, natch)
-->

<scxml 
    xmlns="http://www.w3.org/2005/07/scxml"
    version="1.0"
    profile="ecmascript"
    id="scxmlRoot"
    initial="initial_default"
    name="Canvas">

    <script src="canvas.js"/>
    <script src="../transform.js" type="text/javascript"/>

    <datamodel>
        <!-- these get passed in on initiation -->
        <data id="svg"/>
        <data id="scaleHandle"/>
        <data id="rotationHandle"/>

        <!-- toolbar stuff -->
        <data id="ellipseButton"/>
        <data id="ellipseIcon"/>
        <data id="rectButton"/>
        <data id="rectIcon"/>
        <data id="transformButton"/>
        <data id="transformIcon"/>

        <!-- constant expression -->
        <data id="svgNs" expr="'http://www.w3.org/2000/svg'"/>

        <!-- dynamically changing data -->
        <data id="selectedNodes" expr="[]"/>
        <data id="allNodes" expr="[]"/>

    </datamodel>

    <state id="initial_default">
        <transition event="init" target="main">
            <assign location="svg" expr="_event.data.svg"/>
            <assign location="scaleHandle" expr="_event.data.scaleHandle"/>
            <assign location="rotationHandle" expr="_event.data.rotationHandle"/>

            <assign location="ellipseButton" expr="_event.data.ellipseButton"/>
            <assign location="ellipseIcon" expr="_event.data.ellipseIcon"/>
            <assign location="rectButton" expr="_event.data.rectButton"/>
            <assign location="rectIcon" expr="_event.data.rectIcon"/>
            <assign location="transformButton" expr="_event.data.transformButton"/>
            <assign location="transformIcon" expr="_event.data.transformIcon"/>
        </transition>
    </state>

    <state id="main"/>

</scxml>

